name: Charm e2e tests

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      arch:
        description: Job runner architecture (amd64 or arm64)
        default: amd64
        type: string
      # Download k8s-snap using either a GH action artifact or a snap channel.
      artifact:
        description: The name of a GH action artifact.
        type: string
      channel:
        description: k8s snap channel.
        type: string
      charm-channel:
        description: k8s charm channel.
        type: string
        default: latest/edge
    secrets:
      CHARMCRAFT_AUTH:
        description: Charmcraft authentication token
        required: false

jobs:
  check-charm-channel:
    name: Check if charm channel is available
    runs-on: ubuntu-latest
    outputs:
      channel-available: ${{ steps.check-channel.outputs.channel-available }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Setup Astral UV
        uses: astral-sh/setup-uv@v6.4.1
      - name: Install tox with UV
        run: uv tool install tox --with tox-uv
      - name: Check charm channel availability
        id: check-channel
        working-directory: ci
        env:
          CHARMCRAFT_AUTH: ${{ secrets.CHARMCRAFT_AUTH }}
        run: |
          if tox -e k8s-ci -- charm channel-available "${{ inputs.charm-channel }}"; then
            echo "channel-available=true" >> $GITHUB_OUTPUT
          else
            echo "channel-available=false" >> $GITHUB_OUTPUT
          fi

  charm-e2e-tests:
    name: Test ${{ inputs.arch }} ${{ inputs.artifact }}
    needs: check-charm-channel
    if: needs.check-charm-channel.outputs.channel-available == 'true'
    runs-on: ${{ inputs.arch == 'arm64' && 'self-hosted-linux-arm64-jammy-large' || 'self-hosted-linux-amd64-jammy-xlarge' }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Download k8s-snap
        id: download-snap
        uses: ./.github/actions/download-k8s-snap
        with:
          channel: ${{ inputs.channel }}
          artifact: ${{ inputs.artifact }}
      - name: Setup LXD
        uses: canonical/setup-lxd@v0.1.3
      - name: Setup Astral UV
        uses: astral-sh/setup-uv@v6.4.1
      - name: Install tox with UV
        run: uv tool install tox --with tox-uv
      - name: Run charm integration tests
        working-directory: ci
        run: |
          tox -e k8s-ci -- charm integration-test \
            --k8s-snap-path "${{ steps.download-snap.outputs.snap-path }}" \
            --charm-channel "${{ inputs.charm-channel }}" \
            --arch "${{ inputs.arch }}" \
            --k8s-operator-ref "${{ github.base_ref || github.ref_name }}" \
            --workspace "${{ github.workspace }}"
      - name: Upload debug artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: charm-e2e-tests-${{ inputs.arch }}
          path: ${{ github.workspace }}/k8s-operator/tmp/
