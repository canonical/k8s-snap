name: Nightly

on:
  schedule:
    - cron: "0 0 * * *" # Runs every midnight
  pull_request:

permissions:
  contents: read

jobs:
  Mattermost:
    runs-on: ubuntu-latest
    name: Notify Mattermost
    if: ${{ always() }}
    steps:
      - name: Set current formatted date as env variable
        run: echo "FORMATTED_DATE=$(date +'%d/%m/%Y')" >> $GITHUB_ENV
      - name: Notify Mattermost
        uses: mattermost/action-mattermost-notify@master
        with:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_BOT_WEBHOOK_URL }}
          ATTACHMENTS: |
            [
              {
                "fallback": "k8s-snap Nightly CI Status",
                "color": "${{ github.workflow_run.conclusion == 'success' && 'good' || 'danger' }}",
                "title": "k8s-snap Nightly CI Status - ${{ env.FORMATTED_DATE }}",
                "text": "${{ github.workflow_run.conclusion == 'success' && ':white_check_mark: *Success!* CI completed successfully.' || ':x: *Failure!* CI failed, @k8s-crew please fix ASAP. [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'}}",
                "footer": "GitHub Actions"
              }
            ]
