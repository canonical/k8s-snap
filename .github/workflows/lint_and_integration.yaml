name: Lint and integration

on:
  push:
    paths-ignore:
      - 'docs/**'
    branches:
      - main
      - autoupdate/strict
      - 'release-[0-9]+.[0-9]+'
      - 'autoupdate/release-[0-9]+.[0-9]+-strict'
  pull_request:
    paths-ignore:
      - 'docs/**'

permissions:
  contents: read

jobs:
  build-snap:
    name: Build k8s-snap ${{ matrix.patch }} ${{ matrix.arch }}
    uses: ./.github/workflows/build-snap.yaml
    strategy:
      matrix:
        # e.g. strict - right now we only support the classic flavor
        patch: [""]
        arch: ["amd64", "arm64"]
    with:
      flavor: ${{ matrix.patch }}
      arch: ${{ matrix.arch }}

  test-branches:
    name: Test Branch Management
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'
      - name: Install tox
        run: sudo apt-get install -y tox
      - name: Extract Kubernetes versions
        id: versions
        run: |
          OLD_VERSION=$(git show ${{ github.event.pull_request.base.sha }}:build-scripts/components/kubernetes/version)
          NEW_VERSION=$(cat build-scripts/components/kubernetes/version)

          echo "Old Kubernetes version (base): $OLD_VERSION"
          echo "New Kubernetes version (PR):   $NEW_VERSION"

          OLD_MINOR=$(echo $OLD_VERSION | cut -d. -f2)
          NEW_MINOR=$(echo $NEW_VERSION | cut -d. -f2)

          echo "Old Kubernetes minor version (base): $OLD_MINOR"
          echo "New Kubernetes minor version (PR):   $NEW_MINOR"

          # Only run the branch_management tests if the minor version is the same
          if [ "$OLD_MINOR" = "$NEW_MINOR" ]; then
            echo "kubernetes_minor_same=true" >> $GITHUB_ENV
          else
            echo "kubernetes_minor_same=false" >> $GITHUB_ENV
          fi

      - name: Run branch_management tests
        if: env.kubernetes_minor_same == 'true'
        run: |
          tox -c tests/branch_management -e test
  python-lint:
    name: Python lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install tox
        run: sudo apt-get install -y tox
      - name: Lint
        run: |
          cd tests/integration && tox -e lint
  go-lint-and-unit:
    name: Go lint and unit tests
    uses: ./.github/workflows/go.yaml
    permissions:
      contents: read  # for actions/checkout to fetch code
      pull-requests: write  # for marocchino/sticky-pull-request-comment to create or update PR comment
      checks: write # for golangci/golangci-lint-action to checks to allow the action to annotate code in the PR.

  get-e2e-tags:
    name: Get e2e test tags
    runs-on: ubuntu-latest
    outputs:
      test-tags: ${{ steps.get-e2e-tags.outputs.test-tags }}
    needs: [build-snap, go-lint-and-unit, python-lint]
    steps:
      - name: Checking out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Get e2e test tags
        id: get-e2e-tags
        run: |
          tags="pull_request"
          if ${{ github.event_name == 'pull_request' }}; then
            # Run all tests if there are test changes. In case of a PR, we'll
            # get a merge commit that includes all changes.
            if git diff HEAD HEAD~1 --name-only | grep "tests/"; then
              tags="up_to_weekly"
            fi
            # Run all tests if there are any changes to the Kubernetes components / features.
            if git diff HEAD HEAD~1 --name-only | grep "k8sd/features/.*/"; then
              tags="up_to_weekly"
            fi
            # Run all tests on backports.
            if echo ${{ github.base_ref }} | grep "release-"; then
              tags="up_to_weekly"
            fi
          fi
          echo "test-tags=$tags" >> "$GITHUB_OUTPUT"
  test-integration:
    name: Integration
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    needs: [build-snap, get-e2e-tags, go-lint-and-unit, python-lint]
    uses: ./.github/workflows/e2e-tests.yaml
    with:
      arch: ${{ matrix.arch }}
      os: ubuntu:24.04
      test-tags: ${{ needs.get-e2e-tags.outputs.test-tags }}
      artifact: k8s-${{ matrix.arch }}.snap
      parallel: true

  security-scan:
    name: Security scan
    needs: build-snap
    uses: ./.github/workflows/security-scan.yaml
    with:
      artifact: ${{ needs.build-snap.outputs.snap-artifact }}
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results

  get-charm-channel:
    name: Determine the charm channel
    outputs:
      charm-channel: ${{ steps.parse-branch.outputs.charm-channel }}
    runs-on: ubuntu-latest
    steps:
      - name: Parse branch name
        id: parse-branch
        env:
          # Use either the base (destination) branch name for PRs or
          # "ref_name" on push.
          BRANCH_NAME: ${{ github.base_ref || github.ref_name }}
        run: |
          release=$(echo $BRANCH_NAME | grep -Po "release-\d+\.\d+" | cut -d "-" -f 2)
          if [[ -n $release ]]; then
            # Stable releases don't have an "edge" track, we'll use beta.
            channel="$release/beta"
          else
            channel=latest/edge
          fi
          echo "charm-channel=$channel" >> "$GITHUB_OUTPUT"

  check-charm-operator-release:
    name: Check if k8s-operator has matching release
    outputs:
      has-matching-release: ${{ steps.check-release.outputs.has-matching-release }}
      release-version: ${{ steps.check-release.outputs.release-version }}
    runs-on: ubuntu-latest
    steps:
      - name: Check k8s-operator release
        id: check-release
        env:
          BRANCH_NAME: ${{ github.base_ref || github.ref_name }}
        run: |
          # Parse the k8s-snap release version (e.g., release-1.30 -> 1.30)
          release_version=$(echo "$BRANCH_NAME" | grep -Po "release-\K\d+\.\d+")

          if [[ -z $release_version ]]; then
            # Not a release branch, assume main/latest - always run tests
            echo "Not a release branch, will run charm e2e tests"
            echo "has-matching-release=true" >> "$GITHUB_OUTPUT"
            echo "release-version=main" >> "$GITHUB_OUTPUT"
          else
            echo "Detected k8s-snap release version: $release_version"
            echo "release-version=$release_version" >> "$GITHUB_OUTPUT"

            # Check if k8s-operator has a matching release branch or tag
            echo "Checking k8s-operator for release-$release_version..."

            # Check for branch
            if git ls-remote --heads https://github.com/canonical/k8s-operator \
               2>/dev/null | grep -q "refs/heads/release-$release_version$"; then
              echo "Found matching k8s-operator branch: release-$release_version"
              echo "has-matching-release=true" >> "$GITHUB_OUTPUT"
            # Check for tag
            elif git ls-remote --tags https://github.com/canonical/k8s-operator \
                 2>/dev/null | grep -q "refs/tags/release-$release_version$"; then
              echo "Found matching k8s-operator tag: release-$release_version"
              echo "has-matching-release=true" >> "$GITHUB_OUTPUT"
            else
              echo "No matching k8s-operator release found for $release_version"
              echo "has-matching-release=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  charm-e2e-tests:
    name: Charm e2e tests - ${{ matrix.arch }}
    strategy:
      matrix:
        arch: [amd64]
      fail-fast: false
    needs: [build-snap, go-lint-and-unit, python-lint, get-charm-channel,
            check-charm-operator-release]
    if: needs.check-charm-operator-release.outputs.has-matching-release == 'true'
    uses: ./.github/workflows/charm-e2e-tests.yaml
    with:
      arch: ${{ matrix.arch }}
      artifact: k8s-${{ matrix.arch }}.snap
      charm-channel: ${{ needs.get-charm-channel.outputs.charm-channel }}

  charm-e2e-tests-summary:
    name: Charm e2e tests summary
    runs-on: ubuntu-latest
    needs: [check-charm-operator-release, charm-e2e-tests]
    if: always()
    steps:
      - name: Report status
        run: |
          has_release="${{ needs.check-charm-operator-release.outputs.has-matching-release }}"
          if [[ "$has_release" == "false" ]]; then
            release_ver="${{ needs.check-charm-operator-release.outputs.release-version }}"
            echo "::notice::Skipping charm e2e tests: no matching k8s-operator version for release $release_ver"
            echo "Charm e2e tests were skipped because k8s-operator does not have a matching release."
          elif [[ "${{ needs.charm-e2e-tests.result }}" == "skipped" ]]; then
            echo "::notice::Charm e2e tests were skipped"
          elif [[ "${{ needs.charm-e2e-tests.result }}" == "success" ]]; then
            echo "Charm e2e tests completed successfully"
          elif [[ "${{ needs.charm-e2e-tests.result }}" == "failure" ]]; then
            echo "::error::Charm e2e tests failed"
            exit 1
          else
            echo "Charm e2e tests status: ${{ needs.charm-e2e-tests.result }}"
          fi
