name: Documentation Checks

on:
  workflow_dispatch:

  pull_request:
    paths:
      - 'docs/**'
      - 'build-scripts/components/k8sd/**'
permissions:
  contents: read

jobs:
  documentation-checks:
    #    uses: canonical/documentation-workflows/.github/workflows/documentation-checks.yaml@main
    #    with:
      #   working-directory: "docs/canonicalk8s"
      #  fetch-depth: 0
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5

      - name: Get changed files list with git diff
        id: changes
        run: |
          # Fetch the base branch to ensure we have the history for the comparison
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # Use git diff to find files changed between the base branch and the PR branch
          FILE_LIST=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD -- 'docs/canonicalk8s/**/*.md' | \
            sed 's|^docs/canonicalk8s/||' | \
            xargs)

          # Pass the space-delimited list to the step output
          echo "Changed files: $FILE_LIST"
          echo "changed_files=$FILE_LIST" >> $GITHUB_OUTPUT

      - name: linkcheck
        run: |
          CHANGED_FILES="${{ steps.changes.outputs.changed_files }}"

          echo "Running linkcheck with files: $CHANGED_FILES"

          python3 docs/canonicalk8s/.sphinx/linkcheck.py docs/canonicalk8s \
          --install_target install \
          --linkcheck_target linkcheck \
          --makefile Makefile \
          "$CHANGED_FILES"
        shell: bash

      - id: spell-check
        name: Spell Check
        if: success() || failure()
        uses: canonical/documentation-workflows/spellcheck@main
        with:
          working-directory: docs/canonicalk8s

      - name: Inclusive Language Check
        id: woke-step
        if: success() || failure()
        uses: canonical/documentation-workflows/inclusive-language@main
        with:
          working-directory: docs/canonicalk8s

  k8sd-api-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install Python dependencies
        run: pip install -r ci/requirements-ci.txt

      - name: Check k8sd API documentation
        run: python3 ci/k8s-ci.py docs update-k8sd-api
