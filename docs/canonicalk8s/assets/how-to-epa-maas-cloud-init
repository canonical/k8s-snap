#cloud-config

package_update: true
package_upgrade: false
packages:
  - ubuntu-advantage-tools
  - git
  - pciutils
write_files:
  # set kernel option with hugepages and cpu isolation
  - path: /etc/default/grub.d/100-telco_kernel_options.cfg
    content: |
      GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT} intel_iommu=on iommu=pt usbcore.autosuspend=-1 selinux=0 enforcing=0 nmi_watchdog=0 crashkernel=auto softlockup_panic=0 audit=0 tsc=nowatchdog intel_pstate=disable mce=off hugepagesz=1G hugepages=1000 hugepagesz=2M hugepages=0 default_hugepagesz=1G kthread_cpus=0-31 irqaffinity=0-31 nohz=on nosoftlockup nohz_full=32-127 rcu_nocbs=32-127 rcu_nocb_poll skew_tick=1 isolcpus=managed_irq,32-127 console=tty0 console=ttyS0,115200n8"
    permissions: "0644"

  # create sriov VFs
  - path: /etc/netplan/99-sriov_vfs.yaml
    content: |
      network:
        ethernets:
          enp152s0f1:
            virtual-function-count: 128
    permissions: "0600"

  # ensure VFs are bound to vfio-pci driver (so they can be consumed by pods)
  - path: /var/lib/cloud/scripts/per-boot/dpdk_bind.sh
    content: |
      #!/bin/bash
      if [ -d /home/ubuntu/dpdk ]; then
        modprobe vfio-pci
        vfs=$(python3 /home/ubuntu/dpdk/usertools/dpdk-devbind.py -s | grep drv=iavf | awk '{print $1}' | tail -n +11)
        python3 /home/ubuntu/dpdk/usertools/dpdk-devbind.py --bind=vfio-pci $vfs
      fi
    permissions: "0755"

runcmd:
  - pro attach <UBUNTU PRO TOKEN> --no-auto-enable
  - pro enable realtime-kernel --variant generic --assume-yes
  # fetch dpdk driver binding script
  - su ubuntu -c "git clone https://github.com/DPDK/dpdk.git /home/ubuntu/dpdk"

  # update grub with new kernel options
  - update-grub

power_state:
  mode: reboot
